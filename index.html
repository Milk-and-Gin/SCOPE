<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modern Magik Ritual Tracker</title>
  <!-- PWA links -->
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="app-icon-192.png">
  <link rel="apple-touch-icon" href="app-icon-192.png">
  <meta name="theme-color" content="#58318b">
  <style>
    /* Keep your existing CSS here (neutral colours, cards, sliders etc.) */
  </style>
</head>
<body>
  <header>
    <h1>Modern Magik</h1>
    <h2>Ritual Tracker</h2>
  </header>
  <main>
    <form id="scope-form">
      <!-- Meta section omitted for brevity -->
      <div class="card">
        <h3>Inputs (0–1 scale)</h3>
        <!-- existing sliders -->
        <!-- ... -->
        <label>
          <span>κ (kappa)</span>
          <!-- Slider to calibrate Psi, 0–10 range -->
          <input type="range" id="kappa" min="0" max="10" step="0.25" value="1">
          <span class="range-value" id="kappaVal">1.00</span>
        </label>
      </div>
      <div class="card">
        <h3>Outputs</h3>
        <!-- existing outputs for Ψ and P* -->
        <div class="output-row">
          <div class="output-label">Ψ (efficacy)</div>
          <div class="output-bar"><div class="output-fill" id="psiBar"></div></div>
          <div class="output-value" id="psiVal">0.000</div>
        </div>
        <div class="output-row">
          <div class="output-label">P* (enchanted probability)</div>
          <div class="output-bar"><div class="output-fill" id="pStarBar"></div></div>
          <div class="output-value" id="pStarVal">0.500</div>
        </div>
        <div class="btn-row">
          <button type="submit" id="save">Save Entry</button>
          <button type="button" id="download">Download Latest</button>
        </div>
      </div>
    </form>
    <p id="status"></p>
  </main>
  <a class="floating-link" href="https://www.milkandgin.co.uk/scope" target="_blank">Read More About SCOPE</a>
  <script>
    // References for new slider and value
    const inputs = {
      aFocus: document.getElementById('aFocus'),
      bBelief: document.getElementById('bBelief'),
      dAttach: document.getElementById('dAttach'),
      rRes: document.getElementById('rRes'),
      sSkill: document.getElementById('sSkill'),
      lLink: document.getElementById('lLink'),
      rRepr: document.getElementById('rRepr'),
      cCoord: document.getElementById('cCoord'),
      vVitality: document.getElementById('vVitality'),
      qNoise: document.getElementById('qNoise'),
      kappa: document.getElementById('kappa')
    };
    const spans = {
      // existing value spans...
      kappaVal: document.getElementById('kappaVal')
    };
    // compute function now multiplies by kappa
    function compute() {
      const A = parseFloat(inputs.aFocus.value) || 0;
      const B = parseFloat(inputs.bBelief.value) || 0;
      const D = parseFloat(inputs.dAttach.value) || 0;
      const R = parseFloat(inputs.rRes.value) || 0;
      const S = parseFloat(inputs.sSkill.value) || 0;
      const L = parseFloat(inputs.lLink.value) || 0;
      const Rp= parseFloat(inputs.rRepr.value) || 0;
      const C = parseFloat(inputs.cCoord.value) || 0;
      const V = parseFloat(inputs.vVitality.value) || 0;
      const Q = parseFloat(inputs.qNoise.value) || 0;
      const K = parseFloat(inputs.kappa.value) || 1;
      // base model
      const H  = A * B * (1 - D) * (1 - R);
      const X  = S * L * Rp * C;
      const PsiRaw  = K * H * X * V * Q;
      const baseline = 0.5;
      const PStarRaw= baseline + (1 - baseline) * PsiRaw;
      // clamp
      const Psi    = Math.max(0, Math.min(1, PsiRaw));
      const PStar  = Math.max(0, Math.min(1, PStarRaw));
      // scaling for visibility (Psi*10; (PStar-0.5)*5)
      const psiDisplay  = Math.min(Psi * 10, 1);
      const pStarDisplay= Math.min(baseline + (PStar - baseline) * 5, 1);
      document.getElementById('psiBar').style.width   = (psiDisplay * 100) + '%';
      document.getElementById('pStarBar').style.width = (pStarDisplay * 100) + '%';
      document.getElementById('psiVal').textContent   = Psi.toFixed(3);
      document.getElementById('pStarVal').textContent = PStar.toFixed(3);
      return {Psi, PStar};
    }
    // update display values
    function updateDisplay() {
      // existing updates ...
      spans.kappaVal.textContent = parseFloat(inputs.kappa.value).toFixed(2);
    }
    // save to local storage
    function updateLatestEntry() {
      const {Psi, PStar} = compute();
      const entry = {
        date: document.getElementById('date').value,
        location: document.getElementById('location').value,
        tradition: document.getElementById('tradition').value,
        goal: document.getElementById('goal').value,
        A: parseFloat(inputs.aFocus.value) || 0,
        B: parseFloat(inputs.bBelief.value) || 0,
        D: parseFloat(inputs.dAttach.value) || 0,
        R: parseFloat(inputs.rRes.value) || 0,
        S: parseFloat(inputs.sSkill.value) || 0,
        L: parseFloat(inputs.lLink.value) || 0,
        Rp:parseFloat(inputs.rRepr.value) || 0,
        C: parseFloat(inputs.cCoord.value) || 0,
        V: parseFloat(inputs.vVitality.value) || 0,
        Q: parseFloat(inputs.qNoise.value) || 0,
        kappa: parseFloat(inputs.kappa.value) || 1,
        Psi,
        PStar,
        ts: new Date().toISOString()
      };
      localStorage.setItem('modernMagikLatest', JSON.stringify(entry));
    }
    // load saved entry on refresh
    function loadLatestEntry() {
      const data = localStorage.getItem('modernMagikLatest');
      if (data) {
        const entry = JSON.parse(data);
        document.getElementById('date').value = entry.date || '';
        document.getElementById('location').value = entry.location || '';
        document.getElementById('tradition').value = entry.tradition || '';
        document.getElementById('goal').value = entry.goal || '';
        // set slider values
        inputs.aFocus.value   = entry.A;
        inputs.bBelief.value  = entry.B;
        inputs.dAttach.value  = entry.D;
        inputs.rRes.value     = entry.R;
        inputs.sSkill.value   = entry.S;
        inputs.lLink.value    = entry.L;
        inputs.rRepr.value    = entry.Rp;
        inputs.cCoord.value   = entry.C;
        inputs.vVitality.value= entry.V;
        inputs.qNoise.value   = entry.Q;
        inputs.kappa.value    = entry.kappa || 1;
      }
    }
    // attach events
    Object.values(inputs).forEach(el => {
      el.addEventListener('input', () => {
        updateDisplay();
        updateLatestEntry();
        compute();
      });
    });
    document.getElementById('scope-form').addEventListener('submit', e => {
      e.preventDefault();
      // existing save logic...
    });
    document.getElementById('download').addEventListener('click', () => {
      // existing download logic...
    });
    // initial load
    loadLatestEntry();
    updateDisplay();
    compute();
    updateLatestEntry();
  </script>
</body>
</html>
  
